<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chambers Timber Delivery Notification System</title>
    <style>
        /* General Page Styling */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #ffffff;
            margin: 0;
            padding: 0;
            color: black;
        }
        
        /* Banner Styling */
        .banner {
            background-color: #f5de20;
            color: black;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            gap: 10px;
        }
        
        .banner img {
            height: 30px; /* reduced from 50px */
        }
        
        .banner h1 {
            font-size: 20px; /* reduced from 22px */
            margin: 0;
        }
        
        /* Main Layout - Two Columns */
        .main-container {
            display: flex;
            justify-content: flex-start;
            max-width: 900px; /* reduced from 900px */
            margin: 10px auto;
            gap: 10px;
        }
        
        /* History Section */
        .history {
            background: #f5de20;
            padding: 10px;
            width: 35%; /* reduced from 30% */
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease-in-out;
            color: black;
        }
        
        .history h3 {
            border-bottom: 2px solid black;
            padding-bottom: 1px;
            text-align: center;
            font-size: 15px;
        }
        
        /* History List */
        .history-list {
            list-style-type: none;
            padding: 0;
            margin-top: 10px;
            max-height: 750px;
            overflow-y: auto;
        }
        
        .history-list li {
            background: #ffffff;
            padding: 8px;
            margin-bottom: 5px;
            border-left: 4px solid black;
            font-size: 13px;
            text-align: left;
            border-radius: 5px;
            transition: background 0.3s;
            color: black;
        }
        
        .history-list li:hover {
            background: #fafaf8;
        }
        
        /* Notification Form */
        .container {
            background: #b8b3b3;
            padding: 18px; /* reduced from 25px */
            width: 60%; /* increased slightly */
            border-radius: 8px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
            color: black;
        }
        
        /* Form Elements */
        label {
            font-weight: bold;
            font-size: 16px; /* added for tighter layout */
            display: block;
            margin-top: 1px;
            color: rgb(10, 1, 1);
        }
        
        input, select, textarea {
            width: 98%;
            padding: 5px;
            margin-top: 5px;
            border: 2px solid #222220;
            border-radius: 10px;
            font-size: 15px;
            background-color: white;
            color: black;
            
        }
        #customerAddress {
        width: 80%;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #f5de20;
        }
        
        /* Message Preview */
        textarea {
            height: 190px;
            resize: vertical;
            margin-top: 10px;
            background-color: white;
            color: black;
            font-size: 13px;
            padding: 5px;
        }
        
        /* Send Button */
        button {
            background-color: #f5de20;
            color: black;
            border: none;
            padding: 11px;
            cursor: pointer;
            width: 100%;
            border-radius: 5px;
            font-size: 16px; /* reduced from 18px */
            transition: background 0.3s ease, transform 0.2s;
            margin-top: 15px;
        }
        
        button:hover {
            background-color: black;
            color: white;
            transform: scale(1.05);
        }
        
        /* Loading Animation */ 
        #loading {
            text-align: center;
            font-size: 16px; /* reduced from 18px */
            margin-top: 10px;
            color: #f5de20;
            display: none;
        }
        
        /* Success Popup */
        #success-popup {
            position: fixed;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #f5de20;
            color: black;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
            display: none;
        }
        
        /* Clear History Button */
        .clear-history-btn {
            background-color: rgb(240, 21, 21);
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            width: 100%;
            border-radius: 5px;
            font-size: 15px;
            margin-top: 10px;
            transition: background 0.3s ease, transform 0.2s;
        }
        
        .clear-history-btn:hover {
            background-color: white;
            color: black;
            transform: scale(1.05);
        }
        
        /* Success Message Styling */
        #success-message {
            text-align: center;
            font-size: 15px;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 10px;
            display: none;
        }
        .top-banner {
            text-align: right;
            background-color: #ffffff;
         
        }

        .top-banner img {
            max-width: 27%;
            height: auto;
            display: block;
            margin-left: auto;
            margin-right: 550px;
}


        </style>

        <!-- Firebase App (core SDK) -->
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>

<!-- Realtime Database -->
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>

<script>
  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyB7SOflbN-tHTsr7qi20AarWfsoaDJR7Xc",
    authDomain: "ct-delivery-notification.firebaseapp.com",
    databaseURL: "https://ct-delivery-notification-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "ct-delivery-notification",
    storageBucket: "ct-delivery-notification.firebasestorage.app",
    messagingSenderId: "487475599853",
    appId: "1:487475599853:web:2fad921d97dbacebd76fe4",
    measurementId: "G-PVHMPPXZ2R"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
</script>


        
</head>

<!-- üîê LOGIN OVERLAY -->
<!--  <div id="login-overlay" style="
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255, 255, 255, 0.98);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  font-family: Arial, sans-serif;
">
  <h2 style="margin-bottom: 10px;">Chambers Timber Admin Only Access</h2>
  <input type="password" id="login-password" placeholder="Enter password..." style="
    padding: 10px;
    font-size: 16px;
    width: 250px;
    text-align: center;
    border-radius: 6px;
    border: 2px solid #ccc;
  ">
  <button onclick="checkPassword()" style="
  margin-top: 10px;
  padding: 6px 12px;
  font-size: 16px;
  width: 275px;
  text-align: center;
  border: none;
  border-radius: 6px;
  background-color: #f5de20;
  color: black;
  cursor: pointer;
">Login</button>

  <p id="login-error" style="color: red; margin-top: 8px; display: none;">‚ùå Incorrect password</p>
</div>
-->

<!-- FLEX CONTAINER: Main Layout (Left + Right Side) -->
<div style="display: flex; height: 100vh; overflow: hidden;">

    <!-- LEFT SIDE: Main Panel -->
    <div style="width: 30%; min-width: 700px; padding: 20px; background-color: white; overflow-y: auto; box-shadow: 2px 0 5px rgba(0,0,0,0.05);">
      <!-- Success / Status Messages -->
      <div id="loading" class="hidden">Sending... ‚è≥</div>
      <p id="response" class="message"></p>
      <div id="success-popup" class="hidden">‚úÖ Message Sent Successfully!</div>
  
      <!-- SPLIT PANEL: History + Form -->
      <div style="display: flex; gap: 30px;">
        
        <!-- NOTIFICATION FORM -->
        <div class="container" style="flex: 2;">
          <h2 style="margin-top: 0;">üì© WhatsApp Delivery Notification</h2>
  
          <!-- START: FORM FIELDS -->
          <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
              <label for="phone">üìû Customer's Number:</label><br>
              <input type="text" id="phone" value="07894 802 472" style="width: 100%;">
            </div>
            <div style="flex: 1;">
              <label for="orderNumber">üì¶ Order Number:</label><br>
              <input type="text" id="orderNumber" style="width: 95%;">
            </div>
          </div>
  
          <div style="display: flex; gap: 20px; margin-top: 10px;">
            <div style="flex: 1;">
              <label for="deliveryDate">üìÖ Delivery Date</label><br>
              <input type="date" id="deliveryDate" style="width: 100%;">
            </div>
            <div style="flex: 1;">
              <label for="siteContact">üìû Site Contact: </label><br>
              <input type="text" id="siteContact" style="width: 95%;">
            </div>
          </div>
  
          <div style="margin-top: 10px;">
            <label for="customerAddress">üìç Delivery Address:</label><br>
            <input type="text" id="customerAddress" placeholder="397 Romford Rd, E7 8AB" style="width: 98%;">
          </div>
  
          <div style="display: flex; gap: 20px; margin-top: 10px;">
            <div style="flex: 2;">
              <label for="messageTemplate">üìù Select Message:</label><br>
              <select id="messageTemplate" onchange="updateMessage()" style="width: 100%;">
                <option value="">Choose a template...</option>
                <option value="HXe409d244b93e3dd70144789d2e797664">DELIVERY</option>
                <option value="HXb930591ce15ddf1213379a48a92349e0">CONFIRMATION</option>
                <option value="HXea334a5a136b808854eab2755556dd29">COLLECTION</option>
              </select>
            </div>
            <div style="flex: 1;">
              <label for="etaDropdown">‚è± ETA:</label><br>
              <select id="etaDropdown" onchange="updateMessage()" style="width: 100%;">
                <option value="">Select ETA...</option>
                <option value="7:00am - 9:00am">7am - 9am</option>
                <option value="9:00am - 11:00am">9am - 11am</option>
                <option value="11:00am - 1:00pm">11am - 1pm</option>
                <option value="1:00pm - 4:00pm">1pm - 4pm</option>
                <option value="7:00am - 12:00pm">7am - 12pm</option>
                  <option value="12:00pm - 4:00pm">12pm - 4pm</option>
                  <option value="7:00am - 8:00am">7am - 8am</option>
                  <option value="8:00am - 9:00am">8am - 9am</option>
                  <option value="9:00am - 10:00am">9am - 10am</option>
                  <option value="10:00am - 11:00am">10am - 11am</option>
                  <option value="11:00am - 12:00pm">11am - 12pm</option>
                  <option value="12:00pm - 1:00pm">12pm - 1pm</option>
                  <option value="1:00pm - 2:00pm">1pm - 2pm</option>
                  <option value="2:00pm - 3:00pm">2pm - 3pm</option>
                  <option value="3:00pm - 4:00pm">3pm - 4pm</option>
                  <option value="8:00am - 10:00am">8am - 10am</option>
                  <option value="10:00am - 12:00am">10pm - 12pm</option>
                  <option value="12:00pm - 2:00pm">12pm - 2pm</option>
                  <option value="2:00pm - 4:00pm">2pm - 4pm</option>
                  <option value="AM">AM</option>
                  <option value="PM">PM</option>
                  <option value="Multidrop">Multidrop</option>
              </select>
            </div>
          </div>
  
          <div style="margin-top: 10px;">
            <label for="message">üñäÔ∏è Message Preview:</label><br>
            <textarea id="message" readonly style="width: 98%; height: 80px;"></textarea>
          </div>
  
          <div style="display: flex; gap: 20px; margin-top: 10px;">
            <div style="flex: 1;">
              <label for="driver">üöõ Select Driver:</label><br>
              <select id="driver" style="width: 100%;">
                <option value="">Choose a driver...</option>
                <option value="Russel - +447584659474">Russel</option>
                <option value="Ricky - +447584659474">Ricky</option>
                <option value="Terry - +447584659474">Terry</option>
                <option value="Jay - +447584659474">Jay</option>
                <option value="John - +447584659474">John</option> 
              </select>
            </div>
            <div style="flex: 1;">
              <label for="vehicleReg">üöó Vehicle Reg:</label><br>
              <select id="vehicleReg" style="width: 100%;">
                <option value="">Choose a vehicle...</option>
                <option value="3.5 Ton Flatbed">3.5 Ton Flatbed</option>
                <option value="18 Ton (HIAB)">18 Ton HIAB</option>
              </select>
            </div>
          </div>
  
          <button onclick="sendMessage()" style="margin-top: 15px;">Send Notification</button>
          <button onclick="saveForLater()" style="margin-top: 10px; background-color: #007bff; color: white;">üöö Book In </button>
          <button onclick="clearForm()" style="margin-top: 10px; background-color: #6c757d; color: white;">Clear Form</button>


        </div>
      </div>
    </div>
    <!-- END: FORM FIELDS -->

   <!-- ************************************************************************************************ -->
   <!-- RIGHT SIDE: Saved for Later + Inbox + Chat + Reply -->


<!-- Right Panel with Tabbed Sections -->
<!-- RIGHT PANEL -->
<div style="width: 70%; background-color: #eef1f5; display: flex; flex-direction: column; height: 100vh; padding: 20px; overflow: hidden;">

  <!-- Tabs Header -->
  <div style="display: flex; gap: 10px; margin-bottom: 10px;">
    <button onclick="showTab('savedTab')">üöö Booked Deliveries</button>
    <button onclick="showTab('historyTab')">üìú Order History</button>
    <button onclick="showTab('inboxTab')">üí¨ Inbox & Chat</button>
  </div>

  <!-- SAVED ORDERS TAB -->
  <div id="savedTab" class="tab-section" style="flex: 1; overflow-y: auto;">
    <h3> üöö Booked Deliveries</h3>
    <div id="saved-for-later" style="max-height: 635px; overflow-y: auto;">Loading...</div>
    <div style="margin-top: 10px; display: flex; justify-content: flex-end; gap: 10px;">
      <button onclick="printSavedLater()" style="background-color: green; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer;">üñ®Ô∏è Print</button>
      <button onclick="clearSavedLater()" style="background-color: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer;">üóëÔ∏è Clear All</button>
    </div>
  </div>

 <!-- ORDER HISTORY TAB -->
<div id="historyTab" class="tab-section" style="display: none; flex: 1; overflow-y: auto;">
  <h3>üìú Order History</h3>
  <ul id="history-list" class="history-list" style="max-height: 624px; overflow-y: auto; border: 1px solid #ccc; background: #f9f9f9; list-style-type: none;"></ul>
  
  <div style="margin-top: 10px; display: flex; justify-content: flex-end;">
    <button onclick="clearOrderHistory()" style="
      background-color: #dc3545;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      font-size: 13px;
      cursor: pointer;
    ">
      üóëÔ∏è Clear All
    </button>
  </div>
</div>



  <!-- Inbox and Chat Tab -->
<div id="inboxTab" class="tab-section" style="display: none; flex: 1; overflow-y: auto;">

  <!-- Inbox -->
  <h3 style="margin-bottom: 10px;">üì• Inbox</h3>
  <div id="inbox" style="
    background-color: #ffffff;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 10px;
    font-size: 13px;
    max-height: 150px;
    overflow-y: auto;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  "></div>

  <!-- Chat Thread -->
  <h3 style="margin-bottom: 10px;">üí¨ Message Chat</h3>
  <div id="chat-thread" style="
    background-color: #ffffff;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 10px;
    font-size: 13px;
    height: 150px;
    overflow-y: auto;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 10px;
  "></div>

  <!-- Reply Input -->
  <textarea id="replyMessage" placeholder="Type your reply here..." style="
    width: 100%;
    height: 80px;
    font-size: 13px;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    resize: vertical;
    margin-bottom: 10px;
  "></textarea>

  <button onclick="addReply()" style="
    width: 100%;
    background-color: #007bff;
    color: white;
    padding: 12px;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
  ">Send Reply</button>
</div>


</div> <!-- ‚úÖ closes the right panel wrapper -->

 

<script>

function showTab(id) {
  document.querySelectorAll('.tab-section').forEach(tab => tab.style.display = 'none');
  document.getElementById(id).style.display = 'block';
}


  function showTab(tabId) {
    document.querySelectorAll('.tab-section').forEach(tab => tab.style.display = 'none');
    document.getElementById(tabId).style.display = 'block';
  }
</script>



<script>
  function loadInbox() {
    fetch('https://delivery-notification.onrender.com/inbox')
      .then(res => res.json())
      .then(data => {
        const inboxDiv = document.getElementById('inbox');
        inboxDiv.innerHTML = '';

        if (data.length === 0) {
          inboxDiv.innerHTML = '<div style="color: gray; font-style: italic;">No incoming messages yet.</div>';
          return;
        }

        data.forEach(msg => {
          const div = document.createElement('div');
          div.className = 'inbox-item';
          div.style.padding = '6px 0';
          div.style.borderBottom = '1px solid #eee';
          div.style.cursor = 'pointer';
          div.innerHTML = `<strong>${msg.number}</strong> ‚Äì ${msg.message}`;
          div.onclick = () => openChat(msg.number, msg.message);
          inboxDiv.appendChild(div);
        });
      })
      .catch(err => console.error('‚ùå Failed to load inbox:', err));
  }

  function openChat(number, message) {
    const chatThread = document.getElementById('chat-thread');
    chatThread.innerHTML = ''; // Clear previous messages

    const msg = document.createElement('div');
    msg.innerHTML = `<strong style="color: #28a745;">üìû ${number}</strong><br>${message}`;
    msg.style.marginBottom = '10px';
    chatThread.appendChild(msg);
  }

  setInterval(loadInbox, 5000); // Refresh inbox every 5 seconds

  window.onload = () => {
  loadInbox();
  document.getElementById('deliveryDate').value = getDefaultDeliveryDate(); // ‚úÖ Fix applied here
};


</script>


  <script>
    function addReply() {
      const msg = document.getElementById('replyMessage').value.trim();
      if (!msg) return;
  
      const container = document.getElementById('chat-thread');
      const replyBlock = document.createElement('div');
      replyBlock.style.marginBottom = '10px';
      replyBlock.innerHTML = `<strong style="color: #007bff;">üë§ You</strong><br>${msg}`;
      container.appendChild(replyBlock);
  
      document.getElementById('replyMessage').value = '';
      container.scrollTop = container.scrollHeight;
    }
  
    function openChat(number) {
      const chatThread = document.getElementById('chat-thread');
      chatThread.innerHTML = ''; // Clear previous messages
  
      // Simulate loaded messages
      const msg = document.createElement('div');
      msg.innerHTML = `<strong style="color: #28a745;">üìû ${number}</strong><br>Hello, can I get an update on delivery?`;
      msg.style.marginBottom = '10px';
      chatThread.appendChild(msg);
    }


 // ‚úÖ Poll for message status updates every 5 seconds
 setInterval(() => {
  let updated = false;

  firebase.database().ref('messageHistory').once('value')
    .then(snapshot => {
      const history = snapshot.val() || {};
      const updates = [];

      Object.entries(history).forEach(([id, entry]) => {
        if (!entry.messageSid || entry.status === 'read') return;

        fetch(`/message-status/${entry.messageSid}`)
          .then(res => res.json())
          .then(data => {
            if (data.status && data.status !== entry.status) {
              console.log(`üîÑ SID ${entry.messageSid} ‚Üí ${data.status}`);
              firebase.database().ref(`messageHistory/${id}/status`).set(data.status);
              updated = true;
            }
          })
          .catch(err => console.warn('‚ùå Error checking status:', err));
      });

      // Delay UI refresh slightly to ensure updates have time to apply
      setTimeout(() => {
        if (updated) {
          loadHistory();
          displaySavedLater();
        }
      }, 1500);
    });
}, 5000); 

  </script>
  
    <script>
        let loadedFromSaved = false;


        let selectedNumber = null;

function selectMessage(el) {
  // Deselect all
  document.querySelectorAll('.incoming-message').forEach(msg => {
    msg.style.backgroundColor = '';
  });

  // Highlight selected
  el.style.backgroundColor = '#e0f0ff';

  // Store number and update display
  selectedNumber = el.dataset.number;
  document.getElementById('replying-to').innerText = `Replying to: ${selectedNumber}`;
}


function formatUKDate(dateStr) {
  const date = new Date(dateStr);
  if (isNaN(date)) return dateStr;
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear().toString().slice(-2);
  return `${day}/${month}/${year}`;
}

function updateMessage() {
  const orderNumber = document.getElementById('orderNumber').value.trim().toUpperCase();
  const customerAddress = document.getElementById('customerAddress').value.trim();
  const siteContact = document.getElementById('siteContact').value.trim();
  const deliveryDateInput = document.getElementById('deliveryDate').value;
  const selectedTemplate = document.getElementById('messageTemplate').value;

  let fullMessage = "";

  if (orderNumber) {
    fullMessage += `PO: ${orderNumber}\n\n`;
  }

  switch (selectedTemplate) {
    case "HXe409d244b93e3dd70144789d2e797664": // DELIVERY
      fullMessage += `We are pleased to confirm that your order is now on its way.\n\n`;
      break;
    case "HXb930591ce15ddf1213379a48a92349e0": // CONFIRMATION
      fullMessage += `Thank you for shopping with us.\n\nWe are pleased to confirm that your order is now booked in with our transport team, please see below for details. You will receive a delivery notification when your order is on its way.\n\n`;
      break;
    case "HXea334a5a136b808854eab2755556dd29": // COLLECTION
      fullMessage += `Your order is now ready for collection at our yard:\n\nüìç 397 Romford Rd, E7 8AB\n\nKind Regards,\nSales Team @ ChambersTimber.com`;
      document.getElementById('message').value = fullMessage;
      return;
    default:
      fullMessage += `[Select a message template]\n\n`;
      break;
  }

  if (deliveryDateInput) {
    const formattedDate = formatUKDate(deliveryDateInput);
    fullMessage += `üìÖ Delivery Date: ${formattedDate}\n\n`;
  }

  if (customerAddress) {
    fullMessage += `üìç ${customerAddress}\n`;
  }

  if (siteContact) {
    fullMessage += `üìû ${siteContact}\n`;
  }

  fullMessage += `\nKind Regards\nSales Team @ ChambersTimber.com`;

  document.getElementById('message').value = fullMessage;
}


function getDefaultDeliveryDate() {
  const now = new Date();
  if (now.getHours() >= 15) {
    now.setDate(now.getDate() + 1);
  }
  return now.toISOString().split('T')[0];
}
 

function clearForm() {
  document.getElementById('phone').value = "";
  document.getElementById('orderNumber').value = "";
  document.getElementById('customerAddress').value = "";
  document.getElementById('messageTemplate').selectedIndex = 0;
  document.getElementById('message').value = "";
  document.getElementById('siteContact').value = "";
  document.getElementById('driver').selectedIndex = 0;
  document.getElementById('vehicleReg').selectedIndex = 0;
  document.getElementById('etaDropdown').selectedIndex = 0;

  // ‚úÖ Set delivery date to today or tomorrow depending on time
  document.getElementById('deliveryDate').value = getDefaultDeliveryDate();

  console.log("‚úÖ All fields cleared and delivery date set correctly!");
}




// Function to load message history from localStorage 
function displayHistory() {
  const savedHistory = JSON.parse(localStorage.getItem('messageHistory')) || [];
  const historyList = document.getElementById('history-list'); 
  historyList.innerHTML = '';

  

  savedHistory.forEach(item => {
    const entryDiv = document.createElement('div');
    entryDiv.className = 'history-entry'; // use this for styling if needed

    entryDiv.innerText = `Order: ${item.orderNumber}
Template: ${item.templateLabel}
Driver: ${item.driverName} - ${item.driverPhone}
üìÖ ${item.dateTime}, ${item.status}`;

    historyList.prepend(entryDiv);

  });
}

function saveHistory(orderNumber, templateLabel, driverName, driverPhone, customerAddress = '', siteContact = '', deliveryDate = '', eta = '', status = 'Sent', messageSid = '') {

  let formattedDeliveryDate = 'TBC';
  if (deliveryDate) {
    const dateObj = new Date(deliveryDate);
    if (!isNaN(dateObj)) {
      const day = dateObj.toLocaleDateString('en-GB', { weekday: 'long' });
      const dayNum = dateObj.getDate();
      const month = dateObj.toLocaleDateString('en-GB', { month: 'long' });
      formattedDeliveryDate = `${day} ${dayNum} ${month}`;
    }
  }

  const now = new Date();
  const timeSent = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

  const historyItem = {
  orderNumber: orderNumber.trim().toUpperCase(),
  templateLabel: templateLabel || '',
  driverName: driverName || '',
  customerAddress: customerAddress || '',
  siteContact: siteContact || '',
  deliveryDate: formattedDeliveryDate || '',
  eta: eta || '',
  status: status || '',
  messageSid: messageSid || '',
  timeSent,
  timestamp: Date.now()
};

// ‚úÖ Only include driverPhone if it exists
if (driverPhone) {
  historyItem.driverPhone = driverPhone;
}



  // ‚úÖ Ensure it's saving to the correct path
  firebase.database().ref('messageHistory').push(historyItem)
    .then(() => console.log("‚úÖ messageHistory entry saved:", messageSid))
    .catch(err => console.error("‚ùå Failed to save messageHistory:", err));
}






function loadHistory() {
  const historyList = document.getElementById('history-list');
  historyList.innerHTML = 'Loading...';

  firebase.database().ref('messageHistory').once('value')
    .then(snapshot => {
      const data = snapshot.val();
      if (!data) {
        historyList.innerHTML = '<li style="color: gray;">No history yet.</li>';
        return;
      }

      historyList.innerHTML = '';
      const items = Object.entries(data).map(([firebaseId, entry]) => ({ ...entry, firebaseId }));

      items.sort((b, a) => (b.timestamp || 0) - (a.timestamp || 0));

      items.forEach(item => {
        const entry = document.createElement('li');
        entry.style.display = 'flex';
        entry.style.alignItems = 'center';
        entry.style.justifyContent = 'space-between';
        entry.style.gap = '10px';
        entry.style.fontSize = '13px';

        let status = item.status || '';
        let icon = '‚è≥', color = 'gray';
        if (status.toLowerCase() === 'sent') { icon = 'üì®'; color = 'blue'; }
        else if (status.toLowerCase() === 'delivered') { icon = '‚úÖ'; color = 'green'; }
        else if (status.toLowerCase() === 'read') { icon = '‚úÖ‚úÖ'; color = 'black'; }

        const driver = item.driverName || 'N/A';
        const time = item.timeSent || 'N/A';

        // Left: Info
        const info = document.createElement('div');
        info.style.flex = '1';
        info.style.overflow = 'hidden';
        info.style.textOverflow = 'ellipsis';
        info.style.whiteSpace = 'nowrap';
        info.innerHTML = `
          <span style="color: ${color}; margin-right: 5px;">${icon}</span>
          <strong>${item.orderNumber}</strong> |
          ETA: ${item.eta || 'TBC'} |
          ${item.templateLabel} |
          ${item.customerAddress || 'N/A'} |
          ${item.siteContact || 'N/A'} |
          ${item.deliveryDate} |
          Driver: ${driver} |
          Time: ${time}
        `;

        // Right: Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'üóëÔ∏è';
        deleteBtn.style.background = 'transparent';
        deleteBtn.style.border = 'none';
        deleteBtn.style.cursor = 'pointer';
        deleteBtn.style.fontSize = '12px';
        deleteBtn.style.flex = '0';
        deleteBtn.onclick = () => deleteHistoryEntry(item.firebaseId);

        entry.appendChild(info);
        entry.appendChild(deleteBtn);
        historyList.prepend(entry);
      });
    })
    .catch(err => {
      console.error("‚ùå Failed to load history:", err);
      historyList.innerHTML = '<li style="color: red;">Failed to load history.</li>';
    });
}

function deleteHistoryEntry(firebaseId) {
  if (!firebaseId) {
    console.warn("‚ùå No Firebase ID provided for deletion.");
    return;
  }

  if (!confirm("Are you sure you want to delete this history entry?")) return;

  firebase.database().ref(`messageHistory/${firebaseId}`).remove()
    .then(() => {
      console.log(`üóëÔ∏è Deleted history entry: ${firebaseId}`);
      loadHistory(); // Refresh list
    })
    .catch(err => {
      console.error("‚ùå Failed to delete entry:", err);
      alert("Failed to delete this entry. Check internet or Firebase permissions.");
    });
}
function sendCustomerMessage(payload) {
  return fetch('https://delivery-notification.onrender.com/send-message', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
}

function sendDriverMessage(payload) {
  return fetch('https://delivery-notification.onrender.com/send-message', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
}


// Updated sendMessage() function
function sendMessage() {
  const phone = document.getElementById('phone').value.trim();
  const orderNumber = document.getElementById('orderNumber').value.trim().toUpperCase();
  const customerAddress = document.getElementById('customerAddress').value.trim();
  const etaValue = document.getElementById("etaDropdown").value;
  const siteContactInput = document.getElementById('siteContact').value.trim();
  const siteContact = siteContactInput || phone;
  const templateDropdown = document.getElementById('messageTemplate');
  const templateSid = templateDropdown.value;
  const templateLabel = templateDropdown.options[templateDropdown.selectedIndex].text;
  const deliveryDate = document.getElementById('deliveryDate').value;
  const vehicleReg = document.getElementById('vehicleReg').value;

  const responseText = document.getElementById('response');
  const loading = document.getElementById('loading');
  loading.style.display = "block";
  responseText.style.color = "black";
  responseText.innerHTML = "Sending... ‚è≥";

  // Extract driver name and number
  let driverName = '';
  let driverPhone = '';
  const driverValue = document.getElementById('driver').value;
  if (driverValue && driverValue.includes(' - ')) {
    [driverName, driverPhone] = driverValue.split(' - ');
  }

  const sharedPayload = {
  orderNumber,
  eta: etaValue,
  deliveryDate,
  customerAddress,
  siteContact,
  vehicleReg,
  templateSid,
  driver: driverValue  // ‚úÖ Send "Name - Number" string to backend
};


  // ‚úÖ Send to customer
  sendCustomerMessage({ ...sharedPayload, phone })
    .then(response => response.json())
    .then(data => {
      if (!data.success) throw new Error(data.error || "Failed to send customer message.");

      console.log("‚úÖ Sent to customer:", data.sid);
      saveHistory(orderNumber, templateLabel, driverName, driverPhone, customerAddress, siteContact, deliveryDate, etaValue, 'Sent', data.sid);

      // Show confirmation
      responseText.style.color = "green";
      responseText.innerHTML = "Message sent to customer ‚úÖ";

      // Hide after 3 seconds
      setTimeout(() => {
        responseText.innerHTML = "";
      }, 3000);

      // ‚úÖ Send to driver if number is valid
      if (driverPhone && driverPhone.startsWith('+44')) {
        return sendDriverMessage({ ...sharedPayload, phone: driverPhone })
          .then(res => res.json())
          .then(driverData => {
            if (driverData.success) {
              console.log("‚úÖ Sent to driver:", driverData.sid);
            } else {
              console.warn("‚ö†Ô∏è Driver message failed:", driverData.error);
            }
          })
          .catch(err => {
            console.error("‚ùå Error sending to driver:", err.message);
          });
      } else {
        console.log("‚ö†Ô∏è No valid driver number provided.");
      }
    })
    .catch(err => {
      responseText.style.color = "red";
      responseText.innerHTML = `‚ùå ${err.message}`;
    })
    .finally(() => {
      loading.style.display = "none";
      loadHistory();
      clearForm();
    });
}


function pollStatusUpdates() {
  console.log("‚è≥ Polling message statuses...");

  firebase.database().ref('messageHistory').once('value')
    .then(snapshot => {
      const data = snapshot.val();
      if (!data) {
        console.warn("‚ö†Ô∏è No message history found.");
        return;
      }

      Object.entries(data).forEach(([id, entry]) => {
        if (!entry.messageSid) {
          console.warn(`‚ùå No SID for entry ${id}`);
          return;
        }

        if (entry.status === 'read') {
          console.log(`‚úÖ Skipping read message: ${entry.messageSid}`);
          return;
        }

        console.log(`üì§ Checking status for SID: ${entry.messageSid}`);

        fetch(`/message-status/${entry.messageSid}`)
          .then(res => res.json())
          .then(statusData => {
            console.log(`üì© Response for ${entry.messageSid}:`, statusData);

            const newStatus = statusData.status;

            if (
              newStatus &&
              typeof newStatus === 'string' &&
              newStatus.trim() !== '' &&
              newStatus !== entry.status
            ) {
              console.log(`üîÑ Updating ${entry.messageSid}: ${entry.status} ‚Üí ${newStatus}`);
              firebase.database().ref(`messageHistory/${id}/status`).set(newStatus);
            } else {
              console.log(`‚ÑπÔ∏è No update needed for ${entry.messageSid}: current=${entry.status}, new=${newStatus}`);
            }
          })
          .catch(err => console.warn(`‚ùå Failed to fetch status for SID ${entry.messageSid}:`, err));
      });
    })
    .catch(err => console.error("‚ùå Failed to poll message history:", err));
}



function setupLiveStatusUpdates() {
  firebase.database().ref('messageHistory').on('child_changed', snapshot => {
    const updatedEntry = snapshot.val();
    console.log(`üîÅ Live update: ${updatedEntry.orderNumber} status changed to ${updatedEntry.status}`);

    // Refresh UI to reflect the change
    loadHistory();
    displaySavedLater();
  });
}
firebase.database().ref('messageHistory').on('child_added', snapshot => {
  const newEntry = snapshot.val();
  console.log(`üì• New message added: ${newEntry.orderNumber}`);
  loadHistory();
  displaySavedLater();
});


function saveForLater() {
  const phone = document.getElementById('phone').value.trim();
  const orderNumber = document.getElementById('orderNumber').value.trim().toUpperCase();
  const customerAddress = document.getElementById('customerAddress').value.trim();
  const etaValue = document.getElementById("etaDropdown").value;
  const siteContact = document.getElementById('siteContact').value.trim();
  const templateDropdown = document.getElementById('messageTemplate');
  const templateLabel = templateDropdown.options[templateDropdown.selectedIndex].text;
  const templateSid = templateDropdown.value;
  const driverValue = document.getElementById('driver').value || '';
  const driverParts = driverValue.split(' - ');
  const driverName = driverParts[0] || '';
  const driverPhone = driverParts[1] || '';
  const vehicleReg = document.getElementById('vehicleReg').value;
  const deliveryDate = document.getElementById('deliveryDate').value;

  if (!orderNumber || !templateSid) {
    alert("‚ö†Ô∏è Please enter an order number and select a message template before saving.");
    return;
  }

  const entry = {
    id: Date.now().toString() + Math.random().toString(36).substring(2, 8),
    phone,
    orderNumber,
    customerAddress,
    etaValue,
    siteContact,
    templateLabel,
    templateSid,
    driverName,
    driverPhone,
    vehicleReg,
    deliveryDate,
    used: false
  };

  // ‚úÖ Save to Firebase Realtime Database
  firebase.database().ref('savedLater').push(entry)
    .then(() => {
      console.log("‚úÖ Saved to Firebase:", entry.orderNumber);
      displaySavedLater(); // refresh UI from Firebase
      clearForm();
    })
    .catch(error => {
      console.error("‚ùå Firebase save failed:", error);
      alert("Failed to save. Please check your connection or Firebase rules.");
    });
}

let lastDeletedHistory = null; // Global backup

function clearOrderHistory() {
  if (!confirm("Are you sure you want to delete all order history?")) return;

  // Step 1: Backup existing history before clearing
  firebase.database().ref('messageHistory').once('value')
    .then(snapshot => {
      const data = snapshot.val();
      if (!data) {
        alert("Order history is already empty.");
        return;
      }

      lastDeletedHistory = data; // Backup in memory

      // Step 2: Clear from Firebase
      return firebase.database().ref('messageHistory').remove();
    })
    .then(() => {
      console.log("‚úÖ Order history cleared from Firebase");
      loadHistory(); // Refresh UI
      showUndoButton(); // Show undo button
    })
    .catch(error => {
      console.error("‚ùå Failed to clear order history:", error);
      alert("Failed to clear order history. Please check your connection or Firebase rules.");
    });
}


function showUndoButton() {
  const historyTab = document.getElementById('historyTab');
  const existingUndo = document.getElementById('undo-button');
  if (existingUndo) return; // Avoid duplicates

  const undoDiv = document.createElement('div');
  undoDiv.id = 'undo-button';
  undoDiv.style.marginTop = '10px';
  undoDiv.innerHTML = `
    <button onclick="undoClearHistory()" style="
      background-color: #007bff;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      font-size: 13px;
      cursor: pointer;
    ">
      üîÑ Undo Clear
    </button>
  `;
  historyTab.appendChild(undoDiv);

  // Auto-remove after 60 seconds
  setTimeout(() => {
    if (undoDiv && undoDiv.parentNode) {
      undoDiv.remove();
    }
  }, 60000);
}

function undoClearHistory() {
  if (!lastDeletedHistory) {
    alert("Nothing to undo.");
    return;
  }

  // Restore each deleted entry
  const updates = Object.entries(lastDeletedHistory).map(([key, value]) => {
    return firebase.database().ref(`messageHistory/${key}`).set(value);
  });

  Promise.all(updates)
    .then(() => {
      console.log("‚úÖ Order history restored");
      loadHistory();
      document.getElementById('undo-button')?.remove();
    })
    .catch(err => {
      console.error("‚ùå Failed to restore history:", err);
      alert("Could not undo the deletion.");
    });
}


function displaySavedLater() {
  const container = document.getElementById('saved-for-later');
  container.innerHTML = '<div style="color: gray; font-style: italic;">Loading...</div>';

  firebase.database().ref('savedLater').once('value')
    .then(snapshot => {
      const data = snapshot.val();
      if (!data) {
        container.innerHTML = '<div style="color: gray; font-style: italic;">No saved entries yet.</div>';
        return;
      }

      const saved = Object.entries(data).map(([firebaseId, item]) => ({
        ...item,
        firebaseId
      }));

      // Sort by delivery date
      saved.sort((a, b) => new Date(a.deliveryDate || 0) - new Date(b.deliveryDate || 0));

      // Load message history from Firebase
      firebase.database().ref('messageHistory').once('value')
        .then(historySnap => {
          const messageHistory = historySnap.val() ? Object.values(historySnap.val()) : [];

          container.innerHTML = ''; // Clear loading

          saved.forEach(item => {
            const row = document.createElement('div');
            row.style.display = 'flex';
            row.style.alignItems = 'center';
            row.style.justifyContent = 'space-between';
            row.style.gap = '10px';
            row.style.padding = '6px 10px';
            row.style.margin = '0';
            row.style.lineHeight = '1.2';
            row.style.fontSize = '13px';
            row.style.borderBottom = '1px solid #eee';

            const order = item.orderNumber || 'N/A';
            const address = item.customerAddress || 'No Address';
            const contact = item.siteContact || 'No Contact';

            let formattedDate = 'TBC';
            if (item.deliveryDate) {
              const dateObj = new Date(item.deliveryDate);
              if (!isNaN(dateObj)) {
                const day = dateObj.toLocaleDateString('en-GB', { weekday: 'long' });
                const dayNum = dateObj.getDate();
                const month = dateObj.toLocaleDateString('en-GB', { month: 'long' });
                formattedDate = `${day} ${dayNum} ${month}`;
              }
            }

            // ‚úÖ Attempt to match status from message history
            let status = '';
            const match = messageHistory.find(h =>
              h.messageSid &&
              h.orderNumber?.trim().toUpperCase() === item.orderNumber?.trim().toUpperCase()
            );
            if (match && match.status && !['pending', 'queued'].includes(match.status.toLowerCase())) {
              status = match.status;
            }

            const info = document.createElement('div');
            info.innerHTML = `<strong>Order: ${order}</strong> | ${address} | ${contact} | ${formattedDate}`;
            info.style.flex = '1';
            info.style.overflow = 'hidden';
            info.style.textOverflow = 'ellipsis';
            info.style.whiteSpace = 'nowrap';
            info.style.cursor = 'pointer';
            info.onclick = () => loadSavedEntry(item.orderNumber, item.phone);

            const statusLabel = document.createElement('div');
            statusLabel.style.display = 'flex';
            statusLabel.style.alignItems = 'center';
            statusLabel.style.justifyContent = 'center';
            statusLabel.style.gap = '5px';
            statusLabel.style.fontSize = '12px';
            statusLabel.style.flex = '0';
            statusLabel.style.minWidth = '60px';

            if (status) {
              let statusColor = 'gray';
              let icon = '‚è≥';

              if (status.toLowerCase() === 'sent') {
                statusColor = 'blue';
                icon = 'üì®';
              } else if (status.toLowerCase() === 'delivered') {
                statusColor = 'green';
                icon = '‚úÖ';
              } else if (status.toLowerCase() === 'read') {
                statusColor = 'black';
                icon = '‚úÖ‚úÖ';
              }

              statusLabel.style.color = statusColor;
              statusLabel.innerHTML = `
                <span style="font-size: 14px;">${icon}</span>
                <span style="text-transform: lowercase;">${status}</span>
              `;
            }

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'üóëÔ∏è';
            deleteBtn.style.background = 'transparent';
            deleteBtn.style.border = 'none';
            deleteBtn.style.cursor = 'pointer';
            deleteBtn.style.fontSize = '12px';
            deleteBtn.style.flex = '0';
            deleteBtn.onclick = (e) => {
              e.stopPropagation();
              firebase.database().ref(`savedLater/${item.firebaseId}`).remove()
                .then(() => displaySavedLater());
            };

            row.appendChild(info);
            row.appendChild(statusLabel);
            row.appendChild(deleteBtn);
            container.appendChild(row);
          });
        })
        .catch(err => {
          console.error("‚ùå Error loading messageHistory from Firebase:", err);
          container.innerHTML = `<div style="color: red;">Error loading message status: ${err.message}</div>`;
        });
    })
    .catch(error => {
      console.error('‚ùå Error loading savedLater from Firebase:', error);
      container.innerHTML = `<div style="color: red;">Error loading saved entries: ${error.message}</div>`;
    });
}


function printSavedLater() {
  firebase.database().ref('savedLater').once('value')
    .then(snapshot => {
      const data = snapshot.val();
      if (!data) {
        alert("No saved items to print.");
        return;
      }

      const saved = Object.values(data);
      if (saved.length === 0) {
        alert("No saved items to print.");
        return;
      }

      saved.sort((a, b) => new Date(a.deliveryDate || 0) - new Date(b.deliveryDate || 0));

      let html = `
        <div id="print-area">
          <h2>Deliveries booked in with transport</h2>
          <ul style="font-family: Arial; font-size: 12px;">
      `;

      saved.forEach(item => {
        const order = item.orderNumber || 'N/A';
        const address = item.customerAddress || 'N/A';
        const contact = item.siteContact || 'N/A';

        let date = 'N/A';
        if (item.deliveryDate) {
          const dateObj = new Date(item.deliveryDate);
          if (!isNaN(dateObj)) {
            const day = dateObj.toLocaleDateString('en-GB', { weekday: 'long' });
            const dayNum = dateObj.getDate();
            const month = dateObj.toLocaleDateString('en-GB', { month: 'long' });
            const year = dateObj.getFullYear();
            date = `${day} ${dayNum} ${month} ${year}`;
          }
        }

        html += `
          <li style="margin-bottom: 4px; line-height: 1.6;">
            Order: ${order} | ${address} | ${contact} | ${date}
          </li>
          <hr style="border: 1px solid black; margin: 10px 0;">
        `;
      });

      html += `</ul></div>`;

      const originalBody = document.body.innerHTML;
      document.body.innerHTML = html;

      window.print();

      setTimeout(() => {
        document.body.innerHTML = originalBody;
        location.reload(); // Restore UI and reset scripts
      }, 500);
    })
    .catch(error => {
      console.error("‚ùå Firebase print error:", error);
      alert("Failed to print saved entries.");
    });
}


function loadSavedEntry(orderNumber, phone) {
  const container = document.getElementById('saved-for-later');

  firebase.database().ref('savedLater').once('value')
    .then(snapshot => {
      const data = snapshot.val();
      if (!data) {
        alert("Could not find matching saved entry.");
        return;
      }

      const entries = Object.values(data);
      const clean = str => str?.replace(/\s+/g, '').replace(/^0/, '+44') || '';
      const cleanedPhone = clean(phone);
      const cleanedOrder = orderNumber?.trim().toUpperCase();

      const item = entries.find(entry =>
        entry.orderNumber?.trim().toUpperCase() === cleanedOrder &&
        clean(entry.phone) === cleanedPhone
      );

      if (!item) {
        alert("Could not find matching saved entry.");
        return;
      }

      // ‚úÖ Load values into form
      document.getElementById('phone').value = item.phone || '';
      document.getElementById('orderNumber').value = item.orderNumber || '';
      document.getElementById('customerAddress').value = item.customerAddress || '';
      document.getElementById('etaDropdown').value = item.etaValue || '';
      document.getElementById('siteContact').value = item.siteContact || '';
      document.getElementById('messageTemplate').value = item.templateSid || '';
      document.getElementById('driver').value = item.driverName && item.driverPhone ? `${item.driverName} - ${item.driverPhone}` : '';
      document.getElementById('vehicleReg').value = item.vehicleReg || '';
      document.getElementById('deliveryDate').value = item.deliveryDate || '';

      updateMessage();
      loadedFromSaved = true;
    })
    .catch(err => {
      console.error("‚ùå Error loading saved entry from Firebase:", err);
      alert("Error loading saved entry.");
    });
}


function deleteSavedEntry(entryToDelete) {
  firebase.database().ref('savedLater').once('value')
    .then(snapshot => {
      const data = snapshot.val();
      if (!data) return;

      // Find the Firebase key by matching order + phone
      const clean = str => str?.replace(/\s+/g, '').replace(/^0/, '+44') || '';
      const cleanedPhone = clean(entryToDelete.phone);
      const cleanedOrder = entryToDelete.orderNumber?.trim().toUpperCase();

      const matchKey = Object.entries(data).find(([key, item]) =>
        item.orderNumber?.trim().toUpperCase() === cleanedOrder &&
        clean(item.phone) === cleanedPhone
      )?.[0];

      if (!matchKey) return;

      return firebase.database().ref(`savedLater/${matchKey}`).remove();
    })
    .then(() => {
      console.log("üóëÔ∏è Entry deleted");
      displaySavedLater();
    })
    .catch(err => {
      console.error("‚ùå Failed to delete entry:", err);
      alert("Could not delete saved entry.");
    });
}


function clearSavedLater() {
  if (confirm("Are you sure you want to clear all saved entries?")) {
    firebase.database().ref('savedLater').remove()
      .then(() => {
        console.log("‚úÖ All saved orders cleared from Firebase");
        displaySavedLater(); // refresh UI
      })
      .catch(error => {
        console.error("‚ùå Error clearing saved orders from Firebase:", error);
        alert("Failed to clear saved entries. Please check your internet or Firebase rules.");
      });
  }
}


/*function checkPassword() {
  const correctPassword = "timber123"; // üîë Change to your real password
  const entered = document.getElementById('login-password').value;

  if (entered === correctPassword) {
    document.getElementById('login-overlay').style.display = 'none';
  } else {
    document.getElementById('login-error').style.display = 'block';
  }
}*/


//fully working 16/05/25 1537 lines of code
// version 20250516
    </script>
    

</body>
</html> 
