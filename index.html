<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chambers Timber Delivery Notification System</title>
    <style>
        /* General Page Styling */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #ffffff;
            margin: 0;
            padding: 0;
            color: black;
        }
        
        /* Banner Styling */
        .banner {
            background-color: #f5de20;
            color: black;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            gap: 10px;
        }
        
        .banner img {
            height: 30px; /* reduced from 50px */
        }
        
        .banner h1 {
            font-size: 20px; /* reduced from 22px */
            margin: 0;
        }
        
        /* Main Layout - Two Columns */
        .main-container {
            display: flex;
            justify-content: flex-start;
            max-width: 900px; /* reduced from 900px */
            margin: 10px auto;
            gap: 10px;
        }
        
        /* History Section */
        .history {
            background: #f5de20;
            padding: 10px;
            width: 35%; /* reduced from 30% */
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease-in-out;
            color: black;
        }
        
        .history h3 {
            border-bottom: 2px solid black;
            padding-bottom: 1px;
            text-align: center;
            font-size: 15px;
        }
        
        /* History List */
        .history-list {
            list-style-type: none;
            padding: 0;
            margin-top: 10px;
            max-height: 750px;
            overflow-y: auto;
        }
        
        .history-list li {
            background: #ffffff;
            padding: 8px;
            margin-bottom: 5px;
            border-left: 4px solid black;
            font-size: 13px;
            text-align: left;
            border-radius: 5px;
            transition: background 0.3s;
            color: black;
        }
        
        .history-list li:hover {
            background: #fafaf8;
        }
        
        /* Notification Form */
        .container {
            background: #b8b3b3;
            padding: 18px; /* reduced from 25px */
            width: 60%; /* increased slightly */
            border-radius: 8px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
            color: black;
        }
        
        /* Form Elements */
        label {
            font-weight: bold;
            font-size: 16px; /* added for tighter layout */
            display: block;
            margin-top: 1px;
            color: rgb(10, 1, 1);
        }
        
        input, select, textarea {
            width: 98%;
            padding: 5px;
            margin-top: 5px;
            border: 2px solid #222220;
            border-radius: 10px;
            font-size: 15px;
            background-color: white;
            color: black;
            
        }
        #customerAddress {
        width: 80%;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #f5de20;
        }
        
        /* Message Preview */
        textarea {
            height: 190px;
            resize: vertical;
            margin-top: 10px;
            background-color: white;
            color: black;
            font-size: 13px;
            padding: 5px;
        }
        
        /* Send Button */
        button {
            background-color: #f5de20;
            color: black;
            border: none;
            padding: 11px;
            cursor: pointer;
            width: 100%;
            border-radius: 5px;
            font-size: 16px; /* reduced from 18px */
            transition: background 0.3s ease, transform 0.2s;
            margin-top: 15px;
        }
        
        button:hover {
            background-color: black;
            color: white;
            transform: scale(1.05);
        }
        
        /* Loading Animation */ 
        #loading {
            text-align: center;
            font-size: 16px; /* reduced from 18px */
            margin-top: 10px;
            color: #f5de20;
            display: none;
        }
        
        /* Success Popup */
        #success-popup {
            position: fixed;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #f5de20;
            color: black;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
            display: none;
        }
        
        /* Clear History Button */
        .clear-history-btn {
            background-color: rgb(240, 21, 21);
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            width: 100%;
            border-radius: 5px;
            font-size: 15px;
            margin-top: 10px;
            transition: background 0.3s ease, transform 0.2s;
        }
        
        .clear-history-btn:hover {
            background-color: white;
            color: black;
            transform: scale(1.05);
        }
        
        /* Success Message Styling */
        #success-message {
            text-align: center;
            font-size: 15px;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 10px;
            display: none;
        }
        .top-banner {
            text-align: right;
            background-color: #ffffff;
         
        }

        .top-banner img {
            max-width: 27%;
            height: auto;
            display: block;
            margin-left: auto;
            margin-right: 550px;
}


        </style>
        
</head>

<!-- üîê LOGIN OVERLAY -->
<!--  <div id="login-overlay" style="
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255, 255, 255, 0.98);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  font-family: Arial, sans-serif;
">
  <h2 style="margin-bottom: 10px;">Chambers Timber Admin Only Access</h2>
  <input type="password" id="login-password" placeholder="Enter password..." style="
    padding: 10px;
    font-size: 16px;
    width: 250px;
    text-align: center;
    border-radius: 6px;
    border: 2px solid #ccc;
  ">
  <button onclick="checkPassword()" style="
  margin-top: 10px;
  padding: 6px 12px;
  font-size: 16px;
  width: 275px;
  text-align: center;
  border: none;
  border-radius: 6px;
  background-color: #f5de20;
  color: black;
  cursor: pointer;
">Login</button>

  <p id="login-error" style="color: red; margin-top: 8px; display: none;">‚ùå Incorrect password</p>
</div>
-->

<!-- FLEX CONTAINER: Main Layout (Left + Right Side) -->
<div style="display: flex; height: 100vh; overflow: hidden;">

    <!-- LEFT SIDE: Main Panel -->
    <div style="width: 50%; min-width: 700px; padding: 20px; background-color: white; overflow-y: auto; box-shadow: 2px 0 5px rgba(0,0,0,0.05);">
      <!-- Success / Status Messages -->
      <div id="loading" class="hidden">Sending... ‚è≥</div>
      <p id="response" class="message"></p>
      <div id="success-popup" class="hidden">‚úÖ Message Sent Successfully!</div>
  
      <!-- SPLIT PANEL: History + Form -->
      <div style="display: flex; gap: 30px;">
        
        <!-- NOTIFICATION FORM -->
        <div class="container" style="flex: 2;">
          <h2 style="margin-top: 0;">üì© WhatsApp Delivery Notification</h2>
  
          <!-- START: FORM FIELDS -->
          <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
              <label for="phone">üìû Customer's Number:</label><br>
              <input type="text" id="phone" value="07894 802 472" style="width: 100%;">
            </div>
            <div style="flex: 1;">
              <label for="orderNumber">üì¶ Order Number:</label><br>
              <input type="text" id="orderNumber" style="width: 95%;">
            </div>
          </div>
  
          <div style="display: flex; gap: 20px; margin-top: 10px;">
            <div style="flex: 1;">
              <label for="deliveryDate">üìÖ Delivery Date</label><br>
              <input type="date" id="deliveryDate" style="width: 100%;">
            </div>
            <div style="flex: 1;">
              <label for="siteContact">üìû Site Contact: </label><br>
              <input type="text" id="siteContact" style="width: 95%;">
            </div>
          </div>
  
          <div style="margin-top: 10px;">
            <label for="customerAddress">üìç Delivery Address:</label><br>
            <input type="text" id="customerAddress" placeholder="397 Romford Rd, E7 8AB" style="width: 98%;">
          </div>
  
          <div style="display: flex; gap: 20px; margin-top: 10px;">
            <div style="flex: 2;">
              <label for="messageTemplate">üìù Select Message:</label><br>
              <select id="messageTemplate" onchange="updateMessage()" style="width: 100%;">
                <option value="">Choose a template...</option>
                <option value="HXe409d244b93e3dd70144789d2e797664">DELIVERY</option>
                <option value="HXb930591ce15ddf1213379a48a92349e0">CONFIRMATION</option>
                <option value="HXea334a5a136b808854eab2755556dd29">COLLECTION</option>
              </select>
            </div>
            <div style="flex: 1;">
              <label for="etaDropdown">‚è± ETA:</label><br>
              <select id="etaDropdown" onchange="updateMessage()" style="width: 100%;">
                <option value="">Select ETA...</option>
                <option value="7:00am - 9:00am">7am - 9am</option>
                <option value="9:00am - 11:00am">9am - 11am</option>
                <option value="11:00am - 1:00pm">11am - 1pm</option>
                <option value="1:00pm - 4:00pm">1pm - 4pm</option>
                <option value="7:00am - 12:00pm">7am - 12pm</option>
                  <option value="12:00pm - 4:00pm">12pm - 4pm</option>
                  <option value="7:00am - 8:00am">7am - 8am</option>
                  <option value="8:00am - 9:00am">8am - 9am</option>
                  <option value="9:00am - 10:00am">9am - 10am</option>
                  <option value="10:00am - 11:00am">10am - 11am</option>
                  <option value="11:00am - 12:00pm">11am - 12pm</option>
                  <option value="12:00pm - 1:00pm">12pm - 1pm</option>
                  <option value="1:00pm - 2:00pm">1pm - 2pm</option>
                  <option value="2:00pm - 3:00pm">2pm - 3pm</option>
                  <option value="3:00pm - 4:00pm">3pm - 4pm</option>
                  <option value="8:00am - 10:00am">8am - 10am</option>
                  <option value="10:00am - 12:00am">10pm - 12pm</option>
                  <option value="12:00pm - 2:00pm">12pm - 2pm</option>
                  <option value="2:00pm - 4:00pm">2pm - 4pm</option>
                  <option value="AM">AM</option>
                  <option value="PM">PM</option>
                  <option value="Multidrop">Multidrop</option>
              </select>
            </div>
          </div>
  
          <div style="margin-top: 10px;">
            <label for="message">üñäÔ∏è Message Preview:</label><br>
            <textarea id="message" readonly style="width: 98%; height: 80px;"></textarea>
          </div>
  
          <div style="display: flex; gap: 20px; margin-top: 10px;">
            <div style="flex: 1;">
              <label for="driver">üöõ Select Driver:</label><br>
              <select id="driver" style="width: 100%;">
                <option value="">Choose a driver...</option>
                <option value="Russel - 07123456789">Russel</option>
                <option value="Ricky - 07234567890">Ricky</option>
                <option value="Terry - 07345678901">Terry</option>
                <option value="Jay - 07456789012">Jay</option>
                <option value="John - 07567890123">John</option>
              </select>
            </div>
            <div style="flex: 1;">
              <label for="vehicleReg">üöó Vehicle Reg:</label><br>
              <select id="vehicleReg" style="width: 100%;">
                <option value="">Choose a vehicle...</option>
                <option value="3.5 Ton Flatbed">3.5 Ton Flatbed</option>
                <option value="18 Ton (HIAB)">18 Ton HIAB</option>
              </select>
            </div>
          </div>
  
          <button onclick="sendMessage()" style="margin-top: 15px;">Send Notification</button>
          <button onclick="saveForLater()" style="margin-top: 10px; background-color: #007bff; color: white;">üíæ Save for Later</button>

        </div>
      </div>
    </div>
    <!-- END: FORM FIELDS -->

   <!-- ************************************************************************************************ -->
   <!-- RIGHT SIDE: Saved for Later + Inbox + Chat + Reply -->


<!-- Right Panel with Tabbed Sections -->
<!-- RIGHT PANEL -->
<div style="width: 50%; background-color: #eef1f5; display: flex; flex-direction: column; height: 100vh; padding: 20px; overflow: hidden;">

  <!-- Tabs Header -->
  <div style="display: flex; gap: 10px; margin-bottom: 10px;">
    <button onclick="showTab('savedTab')">üíæ Saved Orders</button>
    <button onclick="showTab('historyTab')">üìú Order History</button>
    <button onclick="showTab('inboxTab')">üí¨ Inbox & Chat</button>
  </div>

  <!-- SAVED ORDERS TAB -->
  <div id="savedTab" class="tab-section" style="flex: 1; overflow-y: auto;">
    <h3>üíæ Saved Orders</h3>
    <div id="saved-for-later" style="max-height: 635px; overflow-y: auto;">Loading...</div>
    <div style="margin-top: 10px; display: flex; justify-content: flex-end; gap: 10px;">
      <button onclick="printSavedLater()" style="background-color: green; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer;">üñ®Ô∏è Print</button>
      <button onclick="clearSavedLater()" style="background-color: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer;">üóëÔ∏è Clear All</button>
    </div>
  </div>

  <!-- ORDER HISTORY TAB -->
  <div id="historyTab" class="tab-section" style="display: none; flex: 1; overflow-y: auto;">
    <h3>üìú Order History</h3>
    <ul id="history-list" class="history-list" style="max-height: 670px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f9f9f9; list-style-type: none;"></ul>
  </div>

  <!-- Inbox and Chat Tab -->
<div id="inboxTab" class="tab-section" style="display: none; flex: 1; overflow-y: auto;">

  <!-- Inbox -->
  <h3 style="margin-bottom: 10px;">üì• Inbox</h3>
  <div id="inbox" style="
    background-color: #ffffff;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 10px;
    font-size: 13px;
    max-height: 150px;
    overflow-y: auto;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  "></div>

  <!-- Chat Thread -->
  <h3 style="margin-bottom: 10px;">üí¨ Message Chat</h3>
  <div id="chat-thread" style="
    background-color: #ffffff;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 10px;
    font-size: 13px;
    height: 150px;
    overflow-y: auto;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 10px;
  "></div>

  <!-- Reply Input -->
  <textarea id="replyMessage" placeholder="Type your reply here..." style="
    width: 100%;
    height: 80px;
    font-size: 13px;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    resize: vertical;
    margin-bottom: 10px;
  "></textarea>

  <button onclick="addReply()" style="
    width: 100%;
    background-color: #007bff;
    color: white;
    padding: 12px;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
  ">Send Reply</button>
</div>


</div> <!-- ‚úÖ closes the right panel wrapper -->

 

<script>

function showTab(id) {
  document.querySelectorAll('.tab-section').forEach(tab => tab.style.display = 'none');
  document.getElementById(id).style.display = 'block';
}


  function showTab(tabId) {
    document.querySelectorAll('.tab-section').forEach(tab => tab.style.display = 'none');
    document.getElementById(tabId).style.display = 'block';
  }
</script>



<script>
  function loadInbox() {
    fetch('https://delivery-notification.onrender.com/inbox')
      .then(res => res.json())
      .then(data => {
        const inboxDiv = document.getElementById('inbox');
        inboxDiv.innerHTML = '';

        if (data.length === 0) {
          inboxDiv.innerHTML = '<div style="color: gray; font-style: italic;">No incoming messages yet.</div>';
          return;
        }

        data.forEach(msg => {
          const div = document.createElement('div');
          div.className = 'inbox-item';
          div.style.padding = '6px 0';
          div.style.borderBottom = '1px solid #eee';
          div.style.cursor = 'pointer';
          div.innerHTML = `<strong>${msg.number}</strong> ‚Äì ${msg.message}`;
          div.onclick = () => openChat(msg.number, msg.message);
          inboxDiv.appendChild(div);
        });
      })
      .catch(err => console.error('‚ùå Failed to load inbox:', err));
  }

  function openChat(number, message) {
    const chatThread = document.getElementById('chat-thread');
    chatThread.innerHTML = ''; // Clear previous messages

    const msg = document.createElement('div');
    msg.innerHTML = `<strong style="color: #28a745;">üìû ${number}</strong><br>${message}`;
    msg.style.marginBottom = '10px';
    chatThread.appendChild(msg);
  }

  setInterval(loadInbox, 5000); // Refresh inbox every 5 seconds
  window.onload = () => {
    loadInbox(); // Load on page open
  };
</script>


  <script>
    function addReply() {
      const msg = document.getElementById('replyMessage').value.trim();
      if (!msg) return;
  
      const container = document.getElementById('chat-thread');
      const replyBlock = document.createElement('div');
      replyBlock.style.marginBottom = '10px';
      replyBlock.innerHTML = `<strong style="color: #007bff;">üë§ You</strong><br>${msg}`;
      container.appendChild(replyBlock);
  
      document.getElementById('replyMessage').value = '';
      container.scrollTop = container.scrollHeight;
    }
  
    function openChat(number) {
      const chatThread = document.getElementById('chat-thread');
      chatThread.innerHTML = ''; // Clear previous messages
  
      // Simulate loaded messages
      const msg = document.createElement('div');
      msg.innerHTML = `<strong style="color: #28a745;">üìû ${number}</strong><br>Hello, can I get an update on delivery?`;
      msg.style.marginBottom = '10px';
      chatThread.appendChild(msg);
    }
    // ‚úÖ Poll for message status updates every 5 seconds
// ‚úÖ Poll for message status updates every 5 seconds
setInterval(() => {
    const savedHistory = JSON.parse(localStorage.getItem('messageHistory')) || [];
    let updated = false;

    savedHistory.forEach((entry, index) => {
        if (!entry.messageSid || entry.status === 'read') return; // Skip if no SID or already final

        fetch(`https://delivery-notification.onrender.com/message-status/${entry.messageSid}`)
            .then(res => res.json())
            .then(data => {
                if (data.status && data.status !== entry.status) {
                    console.log(`üîÑ Status update: ${entry.messageSid} changed to ${data.status}`);
                    savedHistory[index].status = data.status;
                    updated = true;
                }
            })
            .catch(err => console.warn('‚ùå Error checking status:', err));
    });

    // ‚úÖ Only update UI once after all fetches complete
    setTimeout(() => {
        if (updated) {
            localStorage.setItem('messageHistory', JSON.stringify(savedHistory));
            loadHistory();         // Refresh left column
            displaySavedLater();   // Refresh right column
        }
    }, 1000);

}, 5000);


  </script>
  
    <script>
        let loadedFromSaved = false;


        let selectedNumber = null;

function selectMessage(el) {
  // Deselect all
  document.querySelectorAll('.incoming-message').forEach(msg => {
    msg.style.backgroundColor = '';
  });

  // Highlight selected
  el.style.backgroundColor = '#e0f0ff';

  // Store number and update display
  selectedNumber = el.dataset.number;
  document.getElementById('replying-to').innerText = `Replying to: ${selectedNumber}`;
}


function formatUKDate(dateStr) {
  const date = new Date(dateStr);
  if (isNaN(date)) return dateStr;
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear().toString().slice(-2);
  return `${day}/${month}/${year}`;
}

function updateMessage() {
  const orderNumber = document.getElementById('orderNumber').value.trim().toUpperCase();
  const customerAddress = document.getElementById('customerAddress').value.trim();
  const siteContact = document.getElementById('siteContact').value.trim();
  const deliveryDateInput = document.getElementById('deliveryDate').value;
  const selectedTemplate = document.getElementById('messageTemplate').value;

  let fullMessage = "";

  if (orderNumber) {
    fullMessage += `PO: ${orderNumber}\n\n`;
  }

  switch (selectedTemplate) {
    case "HXe409d244b93e3dd70144789d2e797664": // DELIVERY
      fullMessage += `We are pleased to confirm that your order is now on its way.\n\n`;
      break;
    case "HXb930591ce15ddf1213379a48a92349e0": // CONFIRMATION
      fullMessage += `Thank you for shopping with us.\n\nWe are pleased to confirm that your order is now booked in with our transport team, please see below for details. You will receive a delivery notification when your order is on its way.\n\n`;
      break;
    case "HXea334a5a136b808854eab2755556dd29": // COLLECTION
      fullMessage += `Your order is now ready for collection at our yard:\n\nüìç 397 Romford Rd, E7 8AB\n\nKind Regards,\nSales Team @ ChambersTimber.com`;
      document.getElementById('message').value = fullMessage;
      return;
    default:
      fullMessage += `[Select a message template]\n\n`;
      break;
  }

  if (deliveryDateInput) {
    const formattedDate = formatUKDate(deliveryDateInput);
    fullMessage += `üìÖ Delivery Date: ${formattedDate}\n\n`;
  }

  if (customerAddress) {
    fullMessage += `üìç ${customerAddress}\n`;
  }

  if (siteContact) {
    fullMessage += `üìû ${siteContact}\n`;
  }

  fullMessage += `\nKind Regards\nSales Team @ ChambersTimber.com`;

  document.getElementById('message').value = fullMessage;
}




function clearForm() {
  document.getElementById('phone').value = "07894 802 472";
  document.getElementById('orderNumber').value = "";
  document.getElementById('customerAddress').value = "";
  document.getElementById('messageTemplate').selectedIndex = 0;
  document.getElementById('message').value = "";
  document.getElementById('siteContact').value = "";
  document.getElementById('driver').selectedIndex = 0;
  document.getElementById('vehicleReg').selectedIndex = 0;
  document.getElementById('etaDropdown').selectedIndex = 0;

  // ‚úÖ Set delivery date to today
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('deliveryDate').value = today;

  console.log("‚úÖ All fields cleared and delivery date set to today!");
}



// Function to load message history from localStorage 
function displayHistory() {
    const savedHistory = JSON.parse(localStorage.getItem('messageHistory')) || [];
    const historyList = document.getElementById('history-list'); 
    historyList.innerHTML = '';

    savedHistory.forEach(item => {
        const entryDiv = document.createElement('div');
        entryDiv.className = 'history-entry'; // use this for styling if needed

        entryDiv.innerText = `Order: ${item.orderNumber}
Template: ${item.templateLabel}
Driver: ${item.driverName} - ${item.driverPhone}
üìÖ ${item.dateTime}, ${item.status}`;

        historyList.appendChild(entryDiv);
    });
}


// ‚úÖ Load history when the page loads
window.onload = () => {
  loadHistory();
  displaySavedLater();

  // ‚úÖ Set delivery date to today on page load
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('deliveryDate').value = today;
};





// Function to save message history to localStorage
function saveHistory(orderNumber, templateLabel, driverName, driverPhone, customerAddress = '', siteContact = '', deliveryDate = '', status = 'Saved', messageSid = '') {
    let savedHistory = JSON.parse(localStorage.getItem('messageHistory')) || [];

    // Format: "Thursday 23rd April"
    let formattedDeliveryDate = '';
    if (deliveryDate) {
        const dateObj = new Date(deliveryDate);
        const day = dateObj.toLocaleDateString('en-GB', { weekday: 'long' });
        const dayNum = dateObj.getDate();
        const month = dateObj.toLocaleDateString('en-GB', { month: 'long' });
        formattedDeliveryDate = `${day} ${dayNum} ${month}`;
    } else {
        formattedDeliveryDate = 'TBC';
    }

    // üïí Add current time
    const now = new Date();
    const timeSent = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

    const historyItem = {
        orderNumber,
        templateLabel,
        driverName,
        driverPhone,
        customerAddress,
        siteContact,
        deliveryDate: formattedDeliveryDate,
        status,
        messageSid,
        timeSent  // ‚úÖ added timestamp
    };

    savedHistory.unshift(historyItem);
    localStorage.setItem('messageHistory', JSON.stringify(savedHistory));
}





function loadHistory() {
    const savedHistory = JSON.parse(localStorage.getItem('messageHistory')) || [];
    const historyList = document.getElementById('history-list');
    historyList.innerHTML = '';

    savedHistory.forEach(item => {
        const entry = document.createElement('li');

        // Handle status display
        let status = item.status || '';
        let statusIcon = '';
        let statusColor = 'gray';

        if (status.toLowerCase() === 'sent') {
            statusIcon = 'üì®';
            statusColor = 'blue';
        } else if (status.toLowerCase() === 'delivered') {
            statusIcon = '‚úÖ';
            statusColor = 'green';
        } else if (status.toLowerCase() === 'read') {
            statusIcon = '‚úÖ‚úÖ';
            statusColor = 'black';
        }

        // Driver and time sent
        const driver = item.driverName || 'N/A';
        const time = item.timeSent || 'N/A';

        // Build final entry
        entry.innerHTML = `
            <span style="color: ${statusColor}; margin-right: 5px;">${statusIcon}</span>
            ${item.orderNumber}  |
            ${item.templateLabel} |
            ${item.customerAddress || 'N/A'} |
            ${item.siteContact || 'N/A'} |
            ${item.deliveryDate} |
            <strong>Driver:</strong> ${driver} |
            <strong>Time:</strong> ${time}
        `;

        historyList.appendChild(entry);
    });
}



// Updated sendMessage() function
function sendMessage() {
  let phone = document.getElementById('phone').value.trim();
  let orderNumber = document.getElementById('orderNumber').value.trim().toUpperCase();
  let customerAddress = document.getElementById('customerAddress').value.trim();
  let etaValue = document.getElementById("etaDropdown").value;
  let siteContactInput = document.getElementById('siteContact').value.trim();
  let siteContact = siteContactInput || phone;
  let templateDropdown = document.getElementById('messageTemplate');
  let templateSid = templateDropdown.value;
  let templateLabel = templateDropdown.options[templateDropdown.selectedIndex].text;
  const driverValue = document.getElementById('driver').value;
  const [driverName, driverPhone] = driverValue.split(' - ');

  let vehicleReg = document.getElementById('vehicleReg').value;
  const responseText = document.getElementById('response');
  const loading = document.getElementById('loading');
  const deliveryDate = document.getElementById('deliveryDate').value;

  if (!phone) {
    responseText.style.color = "red";
    responseText.innerHTML = "Please enter a valid phone number.";
    return;
  }

  // ‚úÖ Only check Delivery Date if Order Confirmation template is selected
  if (templateSid === "HXb930591ce15ddf1213379a48a92349e0" && !deliveryDate) {
    responseText.style.color = "red";
    responseText.innerHTML = "Please select a Delivery Date for Order Confirmations.";
    return;
  }

  loading.style.display = "block";
  responseText.innerHTML = "";

  fetch('https://delivery-notification.onrender.com/send-message', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      phone,
      orderNumber,
      eta: etaValue,
      deliveryDate,
      customerAddress,
      siteContact,
      driver,
      vehicleReg,
      templateSid
    })
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`Server responded with status: ${response.status}`);
    }
    return response.json(); 
  })
  .then(data => {
    loading.style.display = "none";

    if (data.success) {
      responseText.style.color = "green";
      responseText.innerHTML = "Message sent successfully! ‚úÖ";

      const sid = data.sid || '';

      // ‚úÖ Save to message history
      saveHistory(orderNumber, templateLabel, driverName, driverPhone, customerAddress, siteContact, deliveryDate, 'Sent', sid);

      // ‚úÖ Determine if this is an order confirmation
      const isOrderConfirmation = (templateSid === "HXb930591ce15ddf1213379a48a92349e0");

      // ‚úÖ Only add to Saved Orders if not loaded from saved entry
      if (!loadedFromSaved) {
        let saved = JSON.parse(localStorage.getItem('savedLater')) || [];

        // Remove any existing entry with the same order number
        saved = saved.filter(entry => entry.orderNumber !== orderNumber);

        // Add the new entry
       saved.unshift({
          phone,
          orderNumber,
          customerAddress,
          etaValue,
          siteContact,
          templateLabel,
          templateSid,
          driverName,
          driverPhone,
          vehicleReg,
          deliveryDate,
          used: false // Always reset status to false on any re-send
        });


        localStorage.setItem('savedLater', JSON.stringify(saved));
        displaySavedLater(); // refresh Saved Orders panel
      }

      loadHistory();
      clearForm();

      // ‚úÖ Reset flag so future sends can be saved again
      loadedFromSaved = false;

      setTimeout(() => { responseText.innerHTML = ""; }, 3001);
    } else {
      throw new Error(data.error || "Unknown error occurred");
    }
  })
  .catch(error => {
    loading.style.display = "none";
    responseText.style.color = "red";
    responseText.innerHTML = `Error: ${error.message}`;
  });
}





function saveForLater() {
  const phone = document.getElementById('phone').value.trim();
  const orderNumber = document.getElementById('orderNumber').value.trim().toUpperCase();
  const customerAddress = document.getElementById('customerAddress').value.trim();
  const etaValue = document.getElementById("etaDropdown").value;
  const siteContact = document.getElementById('siteContact').value.trim();
  const templateDropdown = document.getElementById('messageTemplate');
  const templateLabel = templateDropdown.options[templateDropdown.selectedIndex].text;
  const templateSid = templateDropdown.value;
  const driverValue = document.getElementById('driver').value || '';
  const driverParts = driverValue.split(' - ');
  const driverName = driverParts[0] || '';
  const driverPhone = driverParts[1] || '';
  const vehicleReg = document.getElementById('vehicleReg').value;
  const deliveryDate = document.getElementById('deliveryDate').value;

  if (!orderNumber || !templateSid) {
    alert("‚ö†Ô∏è Please enter an order number and select a message template before saving.");
    return;
  }

  const entryId = Date.now().toString() + Math.random().toString(36).substring(2, 8);

  const saved = JSON.parse(localStorage.getItem('savedLater')) || [];

  saved.unshift({
    id: entryId,
    phone,
    orderNumber,
    customerAddress,
    etaValue,
    siteContact,
    templateLabel,
    templateSid,
    driverName,
    driverPhone,
    vehicleReg,
    deliveryDate,
    used: false
  });

  localStorage.setItem('savedLater', JSON.stringify(saved));
  displaySavedLater();
  clearForm();
}




function displaySavedLater() {
  const saved = JSON.parse(localStorage.getItem('savedLater')) || [];
  const container = document.getElementById('saved-for-later');
  container.innerHTML = '';

  if (saved.length === 0) {
    container.innerHTML = '<div style="color: gray; font-style: italic;">No saved entries yet.</div>';
    return;
  }

  // Sort by delivery date
  saved.sort((a, b) => {
    const dateA = new Date(a.deliveryDate || 0);
    const dateB = new Date(b.deliveryDate || 0);
    return dateA - dateB;
  });

  const messageHistory = JSON.parse(localStorage.getItem('messageHistory')) || [];

  saved.forEach(item => {
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.alignItems = 'center';
    row.style.justifyContent = 'space-between';
    row.style.gap = '10px';
    row.style.padding = '6px 10px';
    row.style.margin = '0';
    row.style.lineHeight = '1.2';
    row.style.fontSize = '13px';
    row.style.borderBottom = '1px solid #eee';

    const order = item.orderNumber || 'N/A';
    const address = item.customerAddress || 'No Address';
    const driver = item.driverName || 'N/A';

    // Format delivery date
    let formattedDate = 'TBC';
    if (item.deliveryDate) {
      const dateObj = new Date(item.deliveryDate);
      const day = dateObj.toLocaleDateString('en-GB', { weekday: 'long' });
      const dayNum = dateObj.getDate();
      const month = dateObj.toLocaleDateString('en-GB', { month: 'long' });
      formattedDate = `${day} ${dayNum} ${month}`;
    }

    // Determine message status (only show if not pending/queued)
    let status = '';
    if (item.used) {
      const match = messageHistory.find(h =>
        h.messageSid && h.orderNumber === item.orderNumber
      );
      if (match && match.status && !['pending', 'queued'].includes(match.status.toLowerCase())) {
        status = match.status;
      }
    }

    // Order info (left)
    const info = document.createElement('div');
    info.innerHTML = `<strong>Order: ${order}</strong> | ${address} | ${driver} | ${formattedDate}`;
    info.style.flex = '1';
    info.style.overflow = 'hidden';
    info.style.textOverflow = 'ellipsis';
    info.style.whiteSpace = 'nowrap';
    info.style.cursor = 'pointer';
    //if (item.used) info.style.color = 'red';
    info.onclick = () => loadSavedEntry(item.orderNumber, item.phone);

    // Status (middle)
    const statusLabel = document.createElement('div');
    statusLabel.style.display = 'flex';
    statusLabel.style.alignItems = 'center';
    statusLabel.style.justifyContent = 'center';
    statusLabel.style.gap = '5px';
    statusLabel.style.fontSize = '12px';
    statusLabel.style.flex = '0';
    statusLabel.style.minWidth = '60px';

    if (status) {
      let statusColor = 'gray';
      let icon = '‚è≥';

      if (status.toLowerCase() === 'sent') {
        statusColor = 'blue';
        icon = 'üì®';
      } else if (status.toLowerCase() === 'delivered') {
        statusColor = 'green';
        icon = '‚úÖ';
      } else if (status.toLowerCase() === 'read') {
        statusColor = 'black';
        icon = '‚úÖ‚úÖ';
      }

      statusLabel.style.color = statusColor;
      statusLabel.innerHTML = `
        <span style="font-size: 14px;">${icon}</span>
        <span style="text-transform: lowercase;">${status}</span>
      `;
    } else {
      statusLabel.innerHTML = ''; // Leave blank
    }

    // Delete button (right)
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'üóëÔ∏è';
    deleteBtn.style.background = 'transparent';
    deleteBtn.style.border = 'none';
    deleteBtn.style.cursor = 'pointer';
    deleteBtn.style.fontSize = '12px';
    deleteBtn.style.flex = '0';
    deleteBtn.onclick = (e) => {
      e.stopPropagation();
      deleteSavedEntry(item);
    };

    row.appendChild(info);
    row.appendChild(statusLabel);
    row.appendChild(deleteBtn);
    container.appendChild(row);
  });
}








function printSavedLater() {
  const saved = JSON.parse(localStorage.getItem('savedLater')) || [];

  if (saved.length === 0) {
    alert("No saved items to print.");
    return;
  }

  // üîº Sort by delivery date (soonest first)
  saved.sort((a, b) => new Date(a.deliveryDate) - new Date(b.deliveryDate));

  // Create printable content
  let html = `
    <div id="print-area">
      <h2>Daily Delivery Check List</h2>
      <ul style="font-family: Arial; font-size: 14px;">
  `;

  saved.forEach(item => {
    const order = item.orderNumber || 'N/A';
    const address = item.customerAddress || 'N/A';
    const contact = item.siteContact || 'N/A';

    let date = 'N/A';
    if (item.deliveryDate) {
      const dateObj = new Date(item.deliveryDate);
      if (!isNaN(dateObj)) {
        const day = dateObj.toLocaleDateString('en-GB', { weekday: 'long' });
        const dayNum = dateObj.getDate();
        const month = dateObj.toLocaleDateString('en-GB', { month: 'long' });
        const year = dateObj.getFullYear();
        date = `${day} ${dayNum} ${month} ${year}`;
      }
    }

    html += `
  <li style="margin-bottom: 4px; line-height: 1.6;">
    Order: ${order} | ${address} | ${contact} | ${date}
  </li>
  <hr style="border: 1px solid black; margin: 10px 0;">
`;


  });

  html += `</ul></div>`;

  // Temporarily overwrite body for printing
  const originalBody = document.body.innerHTML;
  document.body.innerHTML = html;

  window.print();

  // Restore original body after print
  setTimeout(() => {
    document.body.innerHTML = originalBody;
    location.reload(); // Refresh to reset event listeners etc.
  }, 500);
}

function loadSavedEntry(orderNumber, phone) {
  const saved = JSON.parse(localStorage.getItem('savedLater')) || [];

  // Normalize phone numbers
  const clean = str => str.replace(/\s+/g, '').replace(/^0/, '+44');
  const cleanedPhone = clean(phone);

  const item = saved.find(entry =>
    entry.orderNumber === orderNumber &&
    clean(entry.phone) === cleanedPhone
  );

  if (!item) {
    alert("Could not find matching saved entry.");
    return;
  }

  // ‚úÖ Load values into form
  document.getElementById('phone').value = item.phone || '';
  document.getElementById('orderNumber').value = item.orderNumber || '';
  document.getElementById('customerAddress').value = item.customerAddress || '';
  document.getElementById('etaDropdown').value = item.etaValue || '';
  document.getElementById('siteContact').value = item.siteContact || '';
  document.getElementById('messageTemplate').value = item.templateSid || '';
  document.getElementById('driver').value = item.driverName && item.driverPhone ? `${item.driverName} - ${item.driverPhone}` : '';
  document.getElementById('vehicleReg').value = item.vehicleReg || '';
  document.getElementById('deliveryDate').value = item.deliveryDate || '';

  updateMessage();

  // ‚úÖ Mark this entry as used if not already
  const index = saved.findIndex(entry =>
    entry.orderNumber === orderNumber &&
    clean(entry.phone) === cleanedPhone
  );

  if (index !== -1 && !saved[index].used) {
    saved[index].used = true;
    localStorage.setItem('savedLater', JSON.stringify(saved));
    displaySavedLater();
  }

  // ‚úÖ Set global flag so sendMessage() knows this was loaded
  loadedFromSaved = true;
}


function deleteSavedEntry(entryToDelete) {
  let saved = JSON.parse(localStorage.getItem('savedLater')) || [];

  // Only remove the entry with the matching unique ID
  saved = saved.filter(entry => entry.id !== entryToDelete.id);

  localStorage.setItem('savedLater', JSON.stringify(saved));
  displaySavedLater();
}




function clearSavedLater() {
  if (confirm("Are you sure you want to clear all saved entries?")) {
    localStorage.removeItem('savedLater');
    displaySavedLater();
  }
}

/*function checkPassword() {
  const correctPassword = "timber123"; // üîë Change to your real password
  const entered = document.getElementById('login-password').value;

  if (entered === correctPassword) {
    document.getElementById('login-overlay').style.display = 'none';
  } else {
    document.getElementById('login-error').style.display = 'block';
  }
}*/


//fully working 06/05/25 1135 lines of code

    </script>
    

</body>
</html> 
